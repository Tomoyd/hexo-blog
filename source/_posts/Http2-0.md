---
title: Http2.0
date: 2020-03-25 05:48:11
tags:
keywords:
description:
---

#### 简介

HTTP/2没有改动HTTP的应用语义，方法，状态码，URI和标头字段等概念与http一致

http/2修改了**数据格式化(分帧)**以及在**客户端与服务器间传输的方式**，通过新的分帧层向我们的应用隐藏了所有复杂性，因此所有现有的应用都可以不必修改

特点：让我们的应用更快，更简单，更稳定

目标：

- 支持完整的请求和响应复用来减少延迟
- 压缩HTTP标头字段将协议成本降到最低
- 增加请求优先级
- 服务器推送

手段：

- 流的控制，错误处理，升级机制

支持：

- 数据格式化分帧
- 客户端和服务端传输方式
- 新的二进制分帧层

#### http1.x缺点

- 需要多个连接才能实现并发和缩短延迟
- 不会压缩请求头和响应头，不必要的网络流量
- http1.x 不支持有效的资源优先级，TCP利用率低下

#### http/2

- 支持压缩头部字段和在同一连接上进行多个并发交换，对同一连接上的请求和响应消息进行交错

  并且为http头部是由有效编码

  1. 有效的利用网络资源，**减少感知的延迟时间**
  2. 与其他流竞争减少，提高网络容量的利用率，减少TCP连接

- 设置请求优先级，让更重要的请求更快速的完成

#### 二进制分帧层

> 所有的核心在于新的二进制分帧层 在HTTP层面，TLS之前
>
> 层位于 HTTP API与套接字接口(TSL)之间经过优化的新的编码机制

#### 数据流，消息和帧

> 客户端与服务器之间交换数据的方式
>
> 1. 数据流：已建立的连接内的双向数据流，承载一条或多条消息
> 2. 消息：逻辑请求或响应消息对赢得一系列帧
> 3. 帧：http/2 通信的最小单位，都包含帧头，标识出当前帧所属的数据流

- 所有通信在一个TCP上连接完成，此连接可以承载任意数量的双向数据流
- 每个数据流都有一个唯一的标识符和可选的优先级信息，用于承载双向消息
- 每条消息都是条逻辑的HTTP消息，包含一个或多个帧
- 帧是最小的通信单位，承载着特定类型的数据，如HTTP头部信息，消息负载。
- 来自不同的数据流的帧可以交错发送，然后根据每个帧头的标识符表示来重新组装

简言之，HTTP/2 将 HTTP 协议通信分解为二进制编码帧的交换，这些帧对应着特定数据流中的消息。所有这些都在一个 TCP 连接内复用。 这是 HTTP/2 协议所有其他功能和性能优化的基础。

#### 请求与响应复用

在HTTP1.x中，详细发起多个并行请求提升性能，必须使用多个TCP连接，每个连接交互一个响应

这种模型会导致队首阻塞，造成TCP连接效率低下

HTTP/2 二进制分帧层，突破了这些限制，实现了完整的请求和响应的复用，客户端和服务器可以将HTTP消息分解成互不依赖的帧，交错发送，最后再另一端把他们重新组装起来

#### 数据流优先级

每个数据流都有一个关联的权重和依赖关系

1. 可以为每个数据流分配一个介于1到256之间的整数
2. 每个数据流和其他数据流之间可以存在显式的依赖关系

数据流依赖关系和权重表示传输优先级，而不是要求，因此不能保证特定的处理或传输顺序。 即，客户端无法强制服务器通过数据流优先级以特定顺序处理数据流。 尽管这看起来违反直觉，但却是一种必要行为。 我们不希望在优先级较高的资源受到阻止时，还阻止服务器处理优先级较低的资源

#### 每个来源一个连接

HTTP/2 不再依赖多个 TCP 连接去并行复用数据流；每个数据流都拆分成很多帧，而这些帧可以交错，还可以分别设定优先级。 因此，所有 HTTP/2 连接都是永久的，而且仅需要每个来源一个连接

#### 流控制

流控制是阻止发送方 向 接收方发送大量数据的机制，以免超出后者的需求或处理能力；

HTTP/2 提供了一组简单的构建块，这些构建块允许客户端和服务器实现自己数据流和连接级流控制

- 流控制具有方向性： 每个接收方都可以根据自身需要选择为每个数据流和整个连接设置任意的窗口大小
- 流控制基于信用： 每个接收方都可以公布其初始连接和数据流流控制窗口（以字节为单位），每当发送方发出 `DATA` 帧时都会减小，在接收方发出 `WINDOW_UPDATE` 帧时增大。
- 流控制无法停用：
- 流控制为逐跃点控制，而非端到端的控制：

#### 服务器推送

服务器可以对一个客户端请求发送多个响应；除了对最初请求的响应外，服务器还可以向客户端推送额外资源（图 12-5），而无需客户端明确地请求

所有服务器推送数据流都由 `PUSH_PROMISE` 帧发起，表明了服务器向客户端推送所述资源的意图

在客户端接收到 `PUSH_PROMISE` 帧后，它可以根据自身情况选择拒绝数据流（通过 `RST_STREAM` 帧）

#### 头部压缩

减少头部大小

1. 这种格式支持通过静态霍夫曼代码对传输的标头字段进行编码，从而减小了各个传输的大小。

2. 这种格式要求客户端和服务器同时维护和更新一个包含之前见过的标头字段的索引列表，

3. （换句话说，它可以建立一个共享的压缩上下文），此列表随后会用作参考，对之前传输的值进行有效编码

   出现了针对 TLS 和 SPDY 压缩算法的“犯罪”安全攻击，此攻击会导致会话被劫持。 于是，zlib 压缩算法被 HPACK 替代，后者经过专门设计，可以解决发现的安全问题、实现起来也更高效和简单，当然，可以对 HTTP 标头元数据进行良好压缩